<!-- ####################################################################################### -->
<!-- This page contains the medication specification: more information, intake -->
<!-- ####################################################################################### -->
<template>
    <div class="page" data-name="about">
        <!-- --------------------------- Navigation Bar --------------------------------- -->
        <!-- Contains: Back button and page title ("New Medication") -->
        <div class="navbar">
            <div class="navbar-inner sliding">
                <div class="left">
                    <a href="#" class="link back">
                        <i class="icon icon-back"></i>
                        <span class="ios-only">Back</span>
                    </a>
                </div>
                <div class="title">New Medication</div>
            </div>
        </div>

        <!-- ############################# Scrollable page content ########################## -->
        <div class="page-content" id="page-reminder-content">
            <!-- ----------------------- Medic. image and name on top ------------------------- -->
            <div id="med_info">
                <!-- image -->
                <div id="image-container">
                    <!-- image will be added dynamically in code below-->
                </div>
                <!-- name and link to "more information" -->
                <div id="med_name">
                    <h2>
                        <!-- title will be added dynamically in code below-->
                    </h2>
                    <a href="(.*)" class="item-content item-link">
                        more information
                    </a>
                </div>
            </div>


            <!-- ---------------------------- Set intake  ------------------------------ -->
            <div id="set-reminder">
                <h3>Reminder Settings</h3>
                <p>These values are taken from the package insert. Please customize them according to your doctors
                    recommendations and your personal preferences. </p>
                <div class="toolbar tabbar">
                    <div class="toolbar-inner">
                        <a href="#tab-1" class="tab-link tab-link-active">daily</a>
                        <a href="#tab-2" class="tab-link">weekly</a>
                        <a href="#tab-3" class="tab-link">monthly</a>
                    </div>
                </div>
                <!-- TO BE DONE HERE: Specify "weekly" and "monthly" -->
                <div class="tabs">
                    <!-- -------------------- DAILY --------------------- -->
                    <div id="tab-1" class="tab tab-active list">
                        <ul>
                            <li> <!-- to make it deletable by swiping -->
                                <div class="item-content" id="intake-list">
                                    <div class="flex-grid">

                                        <!--  -------- set time -------- -->
                                        <div class="col1">
                                            <div class="list no-margin" id="timer">
                                                <ul>
                                                    <li>
                                                        <div class="item-content item-input">
                                                            <div class="item-inner">
                                                                <div class="item-input-wrap">
                                                                    <input type="text" placeholder="Time"
                                                                           readonly="readonly"
                                                                           id="demo-picker-date1" class="demo-picker"/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                            <div class="block block-strong no-padding no-margin margin-bottom zeroHeight" id="zeroHeight">

                                            </div>
                                            </div>

                                        <div class="col2">
                                            <i class="material-icons">
                                                expand_more
                                            </i>
                                        </div>
                                        <!--  -------- set amount -------- -->
                                        <div class="col3">
                                            <div class="list no-hairlines-md">
                                                <ul>
                                                    <li>
                                                        <div class="item-content item-input">
                                                            <div class="item-inner">
                                                                <div class="item-input-wrap">
                                                                    <input type="text" value="1" readonly="readonly" class="demo-picker" id="demo-picker-device1"/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col4">
                                            pill(s)
                                        </div>
                                        <div class="col5">
                                            <i class="material-icons">
                                                expand_more
                                            </i>
                                        </div>

                                        <div class="col0">
                                            <i class="material-icons">
                                                delete
                                            </i>
                                        </div>

                                    </div>
                                </div>

                                <!--add intake button-->
                                <div class="flex-grid" id="addIntakebutton">
                                    <div class="2_col0">
                                        <i class="material-icons" class="add_intake">
                                            add_circle_outline
                                        </i>
                                    </div>
                                    <p id="addIntake_Titel" class="add_intake">Add Intake</p>
                                </div>



                            </li>
                        </ul>
                    </div>



                    <!-- -------------------- WEEKLY --------------------- -->
                    <div id="tab-2" class="page-content tab">
                        <div class="block">
                            <p>weekly</p>
                            ...
                        </div>
                    </div>

                    <!-- -------------------- MONTHLY --------------------- -->
                    <div id="tab-3" class="page-content tab">
                        <div class="block">
                            <p>monthly</p>
                            ...
                        </div>
                    </div>
                </div>
            </div>


            <a class="col button button-big button-raised button-fill link"
               id="add_button" href="/">Save</a>
        </div>
    </div>
</template>


<!-- ADD CODE HERE -->
<script>
    return {
        on: {
            pageMounted: function () {
                var self = this;
                var app = self.$app;

                var self = this;
                var app = self.$app;

                var allIntakes = [];
                var intakeAmounts = [];

                var today = new Date();
                allIntakes[0] = app.picker.create({
                    inputEl: '#demo-picker-date1',
                    //toolbar: true,
                    rotateEffect: true,
                    closeByOutsideClick: true,
                    toolbarCloseText: 'Set time',
                    //openIn: 'popover',
                    value: [
                        today.getHours(),
                        today.getMinutes() < 10 ? '0' + today.getMinutes() : today.getMinutes()
                    ],
                    formatValue: function (values, displayValues) {
                        return values[0] + ':' + values[1];
                    },
                    cols: [
                        // Hours
                        {
                            values: (function () {
                                var arr = [];
                                for (var i = 0; i <= 23; i++) {
                                    arr.push(i);
                                }
                                return arr;
                            })(),
                        },
                        // Divider
                        {
                            divider: true,
                            content: ':'
                        },
                        // Minutes
                        {
                            values: (function () {
                                var arr = [];
                                for (var i = 0; i <= 59; i++) {
                                    arr.push(i < 10 ? '0' + i : i);
                                }
                                return arr;
                            })(),
                        }
                    ],
                    on: {
                        change: function (picker, values) {
                            var daysInMonth = new Date(picker.value[2], picker.value[0] * 1 + 1, 0).getDate();
                            if (values[1] > daysInMonth) {
                                picker.cols[1].setValue(daysInMonth);
                            }
                        },
                    }
                });

                intakeAmounts[0] = app.picker.create({
                    inputEl: '#demo-picker-device1',
                    cols: [
                        {
                            textAlign: 'center',
                            values: ['1', '1.5', '2', '2.5', '3', '3.5', '4', '4.5', '5', '5.5', '6', '6.5', '7']
                        }
                    ]
                });

                //for adding a new intake
                var intakeCounter = 1;
                $$('.add_intake').click(function () {
                    // TO DO: erstelle flex grid dynamisch (HTML).
                    //Wichtig: id muss der von inputEl unten entsprechen, also: #demo-picker-date' +intakeCounter
                    var flex_grid = $$('<div class="flex-grid"/>');

                    //Column1
                    var col1 = $$('<div class="col1"/>');
                    var timepicker = $$('<div class="list no-margin" id="timer"/>');
                    var list = $$('<ul/>');
                    var listelement= $$('<li/>');
                    var item_input= $$('<div class="item-content item-input"/>');
                    var item_inner = $$('<div class="item-inner"/>');
                    var item_input_wrap= $$('<div class="item-input-wrap"/>');
                    var input= $$('<input type="text" placeholder="Time" readonly class="demo-picker input-with-value"  class="demo-picker" id="demo-picker-date'+intakeCounter+'" />');

                    item_input_wrap.append(input);
                    item_inner.append (item_input_wrap);
                    item_input.append(item_inner);
                    listelement.append(item_input);
                    list.append(listelement);
                    timepicker.append(list);
                    col1.append(timepicker);

                    var pickerblock= $$('<div class="block block-strong no-padding no-margin margin-bottom" id="zeroHeight"/>');
                    var pickercontainer= $$('<div id="demo-picker-date-container'+intakeCounter+'"/>');

                    pickerblock.append(pickercontainer);
                    col1.append(pickerblock);

                    //Column2
                    var col2 = $$('<div class="col2"/>');
                    var expand_time = $$('<i class="material-icons">expand_more</i>');

                    col2.append(expand_time);

                    //Column3
                    var col3 = $$('<div class="col3"/>');
                    var list_amount = $$('<div class="list no-hairlines-md"/>');
                    var list2 = $$('<ul>');
                    var listelement2 = $$('<li>');
                    var item_input_amount = $$('<div class="item-content item-input"/>');
                    var item_inner_amount = $$('<div class="item-inner"/>');
                    var item_wrap_amount = $$('<div class="item-input-wrap"/>');
                    var input_amount = $$('<input type="text" value="1" readonly class="demo-picker input-with-value"  id="demo-picker-device'+intakeCounter+'"/>');

                    item_wrap_amount.append(input_amount);
                    item_inner_amount.append(item_wrap_amount);
                    item_input_amount.append(item_inner_amount);
                    listelement2.append(item_input_amount);
                    list2.append(listelement2);
                    list_amount.append(list2);
                    col3.append(list_amount);

                    //Column4
                    var col4 = $$('<div class="col4"/>');
                    col4.text("pill(s)");

                    //Column5
                    var col5 = $$('<div class="col5"/>');
                    var expand_amount = $$('<i class="material-icons">expand_more</i>');

                    col5.append(expand_amount);

                    //Column0
                    var col0 = $$('<div class="col0"/>');
                    var trashcan = $$('<i class="material-icons">delete</i>');


                    col0.append(trashcan);


                    flex_grid.append(col1,col2,col3,col4,col5,col0);
                    $$('#intake-list').append(flex_grid);




                    //Zeitpicker
                    var today = new Date();
                    allIntakes[intakeCounter] = app.picker.create({
                        inputEl: '#demo-picker-date' + intakeCounter, //TO DO: +intakeCounter
                        toolbar: true,
                        rotateEffect: true,
                        closeByOutsideClick: true,
                        toolbarCloseText: 'Done',
                        //openIn: 'popover',
                        value: [
                            today.getHours(),
                            today.getMinutes() < 10 ? '0' + today.getMinutes() : today.getMinutes()
                        ],
                        formatValue: function (values, displayValues) {
                            return values[0] + ':' + values[1];
                        },
                        cols: [
                            // Hours
                            {
                                values: (function () {
                                    var arr = [];
                                    for (var i = 0; i <= 23; i++) {
                                        arr.push(i);
                                    }
                                    return arr;
                                })(),
                            },
                            // Divider
                            {
                                divider: true,
                                content: ':'
                            },
                            // Minutes
                            {
                                values: (function () {
                                    var arr = [];
                                    for (var i = 0; i <= 59; i++) {
                                        arr.push(i < 10 ? '0' + i : i);
                                    }
                                    return arr;
                                })(),
                            }
                        ],
                        on: {
                            change: function (picker, values) {
                                var daysInMonth = new Date(picker.value[2], picker.value[0] * 1 + 1, 0).getDate();
                                if (values[1] > daysInMonth) {
                                    picker.cols[1].setValue(daysInMonth);
                                }
                            },
                        }
                    });

                    //Amount picker
                    intakeAmounts[intakeCounter] = app.picker.create({
                        inputEl: '#demo-picker-device' + intakeCounter,
                        cols: [
                            {
                                textAlign: 'center',
                                values: ['1', '1.5', '2', '2.5', '3', '3.5', '4', '4.5', '5', '5.5', '6', '6.5', '7']
                            }
                        ]
                    });

                    intakeCounter++;
                });

                //List items are deletable
                $$('.col0').click(function (event) {
                    var target = event.target;
                    app.dialog.confirm('Do you want to delete this intake?', 'Remindy', () => {
                        $$(target).parent().parent().remove();
                    });
                });


                //Medication information
                //TO BE DONE HERE: currently it always adds ciprofloxacin. If we have time we could arrange that it adds the medication that was entered
                //image
                var img = $$('<img class="medi_image" alt="Medicament"/>');
                var my_src = ciprofloxacin.img; //from database meds.js
                img.attr("src",my_src);
                $$('#image-container').append(img);
                //title
                $$('#med_name h2').text(ciprofloxacin.name); //from database meds.js

                // Click on add intake
                // TO BE DONE HERE: Replace this content so that we can actually add a medication
                $$('.open-alert').on('click', function () {
                    app.dialog.alert('Currently not working.', 'Remindy');
                });

                //Amount: schreibe Eingabe "Pillen pro Tag" in entsprechendes Objekt unter per_day
                //Problem aktuell noch: wir koennen nur Ciprofloxacin hinzufuegen, denn wir haben nur hierfuer einen Eintrag in meds.js. Was machen wir mit anderen Medikamenten? An sich sollte es dynamisch gehen, in diesem Fall muss man aber alle Information zu einem Medikament (siehe meds.js) irgendwie aus dem Internet ziehen
                var pickerDevice = app.picker.create({
                    inputEl: '#demo-picker-device',
                    cols: [
                        {
                            textAlign: 'center',
                            values: ['1', '1.5', '2', '2.5', '3', '3.5', '4', '4.5', '5', '5.5', '6', '6.5', '7']
                        }
                    ]
                });



                // TO DO HERE:Change intake ampunt and time
                //Wichtig dabei: über Ciprofloxacin.intakte.push
                // Das Datum Dabei immer: new Date(2019, 1, 9, XX, YY, 0, 0) - XX und YY mit Stunden und Minuten fuellen




                $$('#add_button').click(function () {

                    ciprofloxacin.intake = [];
                    for(var i=0; i<intakeCounter; i++) {
                        var zeit = allIntakes[i].getValue();
                        console.log(zeit);
                        var datum = new Date(2019, 1, 9, zeit[0], zeit[1], 0, 0);
                        var menge = intakeAmounts[i].getValue();
                        if(menge == undefined)
                            menge=1;
                        ciprofloxacin.intake[i] = {time: datum, amount:menge, taken:false};
                    }

                    app.data.medicationList.push(ciprofloxacin);
                });






            }
        }
    }
</script>

